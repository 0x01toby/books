# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /templates/conf/kubernetes.conf.erb

<label @FLUENT_LOG>
  <match fluent.**>
    @type null
    @id ignore_fluent_logs
  </match>
</label>

# k8s core config, 只收集核心组件的日志cilium, csi, istiod, speaker, jaeger, kube apiserver, kube controller manager等日志．
<source>
  @type tail
  @id in_tail_k8s_core_logs
  path /var/log/containers/cilium-*,/var/log/containers/csi-*,/var/log/containers/istiod-*,/var/log/containers/speaker-*,/var/log/containers/jaeger-*,/var/log/containers/snapshot-*,/var/log/containers/spug-*,/var/log/containers/rook-ceph-*,/var/log/containers/etcd-*,/var/log/containers/kube-apiserver-*,/var/log/containers/kube-controller-*,/var/log/containers/kube-scheduler-*,/var/log/containers/node-exporter-*
  pos_file /var/log/fluentd-k8s-core.log.pos
  tag "raw.kubernetes.core.*"
  exclude_path "#{ENV['FLUENT_CONTAINER_TAIL_EXCLUDE_PATH'] || use_default}"
  read_from_head true
  <parse>
    @type multi_format
    <pattern>
      format json
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      utc true
    </pattern>
    <pattern>
      format regexp
      expression /^(?<time>.+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      time_key time
      utc true
    </pattern>
  </parse>
</source>

<source>
  @type tail
  @id in_tail_k8s_apps_logs
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-k8s-apps.log.pos
  tag "raw.kubernetes.apps.*"
  exclude_path ["/var/log/containers/cilium-*","/var/log/containers/csi-*","/var/log/containers/istiod-*","/var/log/containers/speaker-*","/var/log/containers/jaeger-*","/var/log/containers/snapshot-*","/var/log/containers/spug-*", "/var/log/containers/rook-ceph-*", "/var/log/containers/etcd-*", "/var/log/containers/kube-apiserver-*", "/var/log/containers/kube-controller-*", "/var/log/containers/kube-scheduler-*", "/var/log/containers/node-exporter-*"]
  read_from_head true
  <parse>
    @type multi_format
    <pattern>
      format json
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      utc true
    </pattern>
    <pattern>
      format regexp
      expression /^(?<time>.+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%NZ
      time_key time
      utc true
    </pattern>
  </parse>
</source>


<match raw.kubernetes.**>
  @type detect_exceptions
  remove_tag_prefix raw
  message log
  stream stream
  multiline_flush_interval 5
  max_bytes 500000
  max_lines 1000
</match>

<filter **>
  @type concat
  key message
  multiline_end_regexp /\n$/
  separator ""
</filter>

# 增加meta信息
<filter kubernetes.**>
  @type kubernetes_metadata
  annotation_match ["enableFluentd"]
  skip_container_metadata true
  skip_master_url true
  cache_size 3000
  cache_ttl 1800
</filter>

# 修改元数据
<filter kubernetes.core.**>
  @type record_modifier
  char_encoding utf-8
  <record>
    k8s_node ${record.dig('kubernetes', 'host')}
    k8s_container_id ${record.dig("docker", "container_id")}
    k8s_container ${record.dig('kubernetes', 'container_name')}
    k8s_labels ${record.dig('kubernetes', 'labels')}
    k8s_pod ${record.dig('kubernetes', 'pod_name')}
    k8s_ns ${record.dig('kubernetes', 'namespace_name')}
    docker_local "${Time.at(time).to_datetime.iso8601(9)}"
  </record>
  remove_keys docker,kubernetes,tag,time
</filter>

# 过滤日志
<filter kubernetes.apps.**>
  @type grep
  # annotations包含enableFluentd为true
  <regexp>
    key $.kubernetes.annotations.enableFluentd
    pattern ^true$
  </regexp>
  # 排除istio
  <exclude>
    key $.kubernetes.container_name
    pattern ^istio\-\w+$
 </exclude>
</filter>

# 展开json中的log
<filter kubernetes.apps.**>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field true
  <parse>
    @type multi_format
    <pattern>
      format json
    </pattern>
    <pattern>
      format none
    </pattern>
  </parse>
</filter>

# 应用日志处理
<filter kubernetes.apps.**>
  @type record_modifier
  char_encoding utf-8
  <record>
    k8s_node ${record.dig('kubernetes', 'host')}
    k8s_container_id ${record.dig("docker", "container_id")}
    k8s_container ${record.dig('kubernetes', 'container_name')}
    k8s_pod ${record.dig('kubernetes', 'pod_name')}
    k8s_ns ${record.dig('kubernetes', 'namespace_name')}
    fluentd_worker "#{worker_id}"
    docker_local_time "${Time.at(time).to_datetime.iso8601(9)}"
  </record>
  remove_keys docker,tag,time,kubernetes,log
</filter>
