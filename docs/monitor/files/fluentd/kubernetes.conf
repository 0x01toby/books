# AUTOMATICALLY GENERATED
# DO NOT EDIT THIS FILE DIRECTLY, USE /templates/conf/kubernetes.conf.erb

<label @FLUENT_LOG>
  <match fluent.**>
    @type null
    @id ignore_fluent_logs
  </match>
</label>

# k8s core config, 只收集核心组件的日志cilium, csi, istiod, speaker, jaeger, kube apiserver, kube controller manager等日志．
<source>
  @type tail
  @id in_tail_k8s_core_logs
  path /var/log/containers/cilium-*,/var/log/containers/csi-*,/var/log/containers/istiod-*,/var/log/containers/speaker-*,/var/log/containers/jaeger-*,/var/log/containers/snapshot-*,/var/log/containers/spug-*,/var/log/containers/rook-ceph-*,/var/log/containers/etcd-*,/var/log/containers/kube-apiserver-*,/var/log/containers/kube-controller-*,/var/log/containers/kube-scheduler-*,/var/log/containers/node-exporter-*
  pos_file /var/log/fluentd-k8s-core.log.pos
  tag "kubernetes.core.*"
  exclude_path "#{ENV['FLUENT_CONTAINER_TAIL_EXCLUDE_PATH'] || use_default}"
  read_from_head true
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    utc true
  </parse>
</source>

# k8s app配置只收集应用日志，后面通过grep组件，只保留k8s容器中打了labels为fluentdLoggin: true的日志．
<source>
  @type tail
  @id in_tail_k8s_apps_logs
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-k8s-apps.log.pos
  tag "kubernetes.apps.*"
  exclude_path ["/var/log/containers/cilium-*","/var/log/containers/csi-*","/var/log/containers/istiod-*","/var/log/containers/speaker-*","/var/log/containers/jaeger-*","/var/log/containers/snapshot-*","/var/log/containers/spug-*", "/var/log/containers/rook-ceph-*", "/var/log/containers/etcd-*", "/var/log/containers/kube-apiserver-*", "/var/log/containers/kube-controller-*", "/var/log/containers/kube-scheduler-*", "/var/log/containers/node-exporter-*"]
  read_from_head true
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    utc true
  </parse>
</source>

# 对日志添加kubernetes_metada信息
<filter kubernetes.**>
  @type kubernetes_metadata
  skip_container_metadata true
  skip_master_url true
  cache_size 3000
  cache_ttl 1800
</filter>

# 核心组件日志
<filter kubernetes.core.**>
  @type record_modifier
  char_encoding utf-8
  <record>
    k8s_container_id ${record.dig("docker", "container_id")}
    k8s_node ${record.dig('kubernetes', 'host')}
    k8s_pod_name ${record.dig('kubernetes', 'pod_name')}
    k8s_container_name ${record.dig('kubernetes', 'container_name')}
    k8s_namespace_name ${record.dig('kubernetes', 'namespace_name')}
    k8s_labels ${record.dig('kubernetes', 'labels')}
    time_local "${Time.at(time).to_datetime.iso8601(9)}"
    fluentd_worker "#{worker_id}"
  </record>
  remove_keys docker,kubernetes,tag
</filter>

# # 只允许labels为fluentd-loggin=true的应用记录app日志
<filter kubernetes.apps.**>
  @type grep
  <regexp>
    key $.kubernetes.labels.fluentdLoggin
    pattern ^true$
  </regexp>
</filter>

# 应用日志处理
<filter kubernetes.apps.**>
  @type record_modifier
  char_encoding utf-8
  <record>
    k8s_container_id ${record.dig("docker", "container_id")}
    k8s_node ${record.dig('kubernetes', 'host')}
    k8s_container_name ${record.dig('kubernetes', 'container_name')}
    k8s_labels ${record.dig('kubernetes', 'labels')}
    k8s_pod_name ${record.dig('kubernetes', 'pod_name')}
    k8s_namespace_name ${record.dig('kubernetes', 'namespace_name')}
    time_local "${Time.at(time).to_datetime.iso8601(9)}"
    fluentd_worker "#{worker_id}"
  </record>
  remove_keys docker,kubernetes,tag
</filter>

